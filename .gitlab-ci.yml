---
###############################################################################
# GRAPHQL MODULE PIPELINE
###############################################################################

include:
  - project: 'inuits/gitlab-ci/pipeline-templates'
    file: 'pipelines/applications/graphql-module-pipeline.yml'
    ref: 'v4.10.0'

variables:
  GRAPHQL_IMAGE: 'pza/dams-graphql'
  MOVE_SCHEMA: 'baseSchema.schema.ts'

# ðŸ‘‡ Temporary job for testing
test-job-2:
  stage: test
  tags:
    - prod
  before_script:
    - corepack enable
    - corepack prepare pnpm@9.12.0 --activate
    # First check what's already available
    - echo "Checking available Python:"
    - which python3 || echo "python3 not found"
    - which python || echo "python not found"
    - python3 --version || echo "Cannot get python3 version"
    - python --version || echo "Cannot get python version"
    - pnpm install --include=dev
  script: |
    echo "Node.js version:"
    node --version
    echo "NPM version:"
    npm --version
    echo "OS release:"
    cat /etc/os-release

    # Run tests
    echo "DEBUG: Looking for test files..."
    TEST_FILES=$(find . -path ./node_modules -prune -o -path ./.git -prune -o -type f \( -name "*.test.ts" -o -name "*.spec.ts" \) -print)

    if [ -n "$TEST_FILES" ]; then
      echo "Found test files:"
      echo "$TEST_FILES"
      echo "Running vitest..."
      pnpm exec vitest --run
    else
      echo "No test files found, skipping tests."
    fi